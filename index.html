<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PartyPlus</title>
  <style>
    :root{
      --card:#ffffff;
      --text:#111827;
      --muted:#6b7280;
      --line:#e5e7eb;
      --btn:#111827;
      --btnText:#ffffff;
      --btn2:#eef2ff;
      --btn2Text:#111827;
      --danger:#b91c1c;
      --shadow: 0 10px 30px rgba(0,0,0,.15);
      --radius: 20px;
    }
    html,body{ height:100%; }
    body{
      margin:0;
      color:var(--text);
      font-family: system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      display:flex;
      justify-content:center;
      padding:28px 14px;
      background: linear-gradient(180deg,#0f172a,#111827 60%,#0b1220);
    }

    body.theme-General { background: linear-gradient(180deg,#0f172a,#111827 60%,#0b1220); }
    body.theme-Game-Day, body.theme-Football { background: linear-gradient(180deg,#0b2b4a,#0f172a 60%,#0b1220); }
    body.theme-Birthday { background: linear-gradient(180deg,#7c3aed,#0f172a 60%,#0b1220); }
    body.theme-BBQ, body.theme-Cookout { background: linear-gradient(180deg,#b45309,#0f172a 60%,#0b1220); }
    body.theme-Holiday, body.theme-Christmas, body.theme-New-Years { background: linear-gradient(180deg,#065f46,#0f172a 60%,#0b1220); }
    body.theme-Baby-Shower { background: linear-gradient(180deg,#0ea5e9,#0f172a 60%,#0b1220); }
    body.theme-Beach, body.theme-Pool { background: linear-gradient(180deg,#0284c7,#0f172a 60%,#0b1220); }
    body.theme-Wedding { background: linear-gradient(180deg,#be185d,#0f172a 60%,#0b1220); }

    .wrap{ width: min(520px, 100%); }
    .brand{
      color:#fff;
      font-weight:800;
      font-size:40px;
      letter-spacing:-.02em;
      line-height:1.05;
      margin:8px 0 6px;
    }
    .tag{ color: rgba(255,255,255,.75); margin:0 0 18px; }

    .card{
      background: rgba(255,255,255,.94);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
    }
    .row{ display:flex; align-items:center; justify-content:space-between; gap:12px; }
    .title{ font-size:28px; font-weight:800; margin:0; letter-spacing:-.02em; }
    .sub{ color: var(--muted); margin-top:2px; }
    .sep{ height:1px; background: var(--line); margin:14px 0; }

    .btn{
      border:0;
      border-radius: 999px;
      padding: 12px 16px;
      font-weight:800;
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      transition: transform .06s ease, opacity .2s ease;
    }
    .btn:active{ transform: scale(.98); }
    .btn.primary{ background: var(--btn); color: var(--btnText); }
    .btn.secondary{ background: var(--btn2); color: var(--btn2Text); }
    .btn.danger{ background: #fee2e2; color: var(--danger); }

    .muted{ color: var(--muted); }
    .hide{ display:none !important; }

    label{ font-weight:800; display:block; margin: 10px 0 6px; }
    input, select, textarea{
      width:100%;
      box-sizing:border-box;
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 12px 12px;
      font-size: 16px;
      outline:none;
      background:#fff;
    }
    textarea{ min-height: 110px; resize: vertical; }
    .small{ font-size:12px; color: var(--muted); margin-top:6px; }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,.1);
      color:#fff;
      border:1px solid rgba(255,255,255,.12);
    }

    .detailHead{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom:10px;
    }
    .iconBig{ font-size: 34px; }
    .metaRow{ display:flex; gap:10px; flex-wrap:wrap; color: var(--muted); }
    .metaRow span{ background:#f3f4f6; padding:6px 10px; border-radius:999px; font-weight:700; font-size:12px; }

    ul{ margin: 8px 0 0; padding-left: 18px; }
    li{ margin: 8px 0; }
    #dItems li{
      cursor:pointer;
      user-select:none;
      -webkit-tap-highlight-color: transparent;
      padding: 6px 6px;
      border-radius: 10px;
    }
    #dItems li:active{ background: rgba(17,24,39,.06); }

    .status{
      margin-top:10px;
      color: rgba(255,255,255,.75);
      font-size: 12px;
      min-height: 16px;
    }
  </style>
</head>

<body class="theme-General">
  <div class="wrap">
    <div class="brand">PartyPlus</div>
    <p class="tag">Less group-text chaos. More party.</p>

    <!-- HOME -->
    <div id="homeView" class="card">
      <div class="row">
        <div>
          <div class="title">Your Parties</div>
          <div class="sub">Tap one to open.</div>
        </div>
        <button class="btn secondary" id="createBtn" aria-label="Create a new party">+ Create</button>
      </div>

      <div class="sep"></div>
      <div id="partyList"></div>

      <div class="sep"></div>
      <button class="btn secondary" id="resetBtn" aria-label="Reset all parties">Reset All Parties</button>
      <div class="small">Tip: Use Share to send a link that imports the party on someone else‚Äôs phone.</div>
    </div>

    <!-- FORM -->
    <div id="formView" class="card hide">
      <div class="row">
        <div class="title" id="formTitle">Create Party</div>
        <button class="btn secondary" id="cancelFormBtn" aria-label="Cancel">Home</button>
      </div>

      <label>Party Title</label>
      <input id="fTitle" placeholder="Friday night" />

      <label>Date & Time</label>
      <input id="fWhen" type="datetime-local" />

      <label>Type</label>
      <select id="fType">
        <option>General</option>
        <option>Birthday</option>
        <option>Game Day</option>
        <option>Football</option>
        <option>Baby Shower</option>
        <option>Wedding</option>
        <option>BBQ</option>
        <option>Cookout</option>
        <option>Holiday</option>
        <option>Christmas</option>
        <option>New Years</option>
        <option>Beach</option>
        <option>Pool</option>
      </select>

      <label>Location (optional)</label>
      <input id="fLocation" placeholder="123 Main St, City" />

      <label>Notes (optional)</label>
      <textarea id="fNotes" placeholder="Details, gate code, what to wear‚Ä¶"></textarea>

      <label>Items (one per line)</label>
      <textarea id="fItems" placeholder="Ice&#10;Cups&#10;Chips&#10;Sunscreen"></textarea>
      <div class="small">Tap items later to ‚Äúclaim‚Äù them.</div>

      <div class="sep"></div>

      <div class="row">
        <button class="btn primary" id="saveBtn" aria-label="Save party">Save Party</button>
        <button class="btn danger" id="deleteBtn" aria-label="Delete party">Delete</button>
      </div>
    </div>

    <!-- DETAIL -->
    <div id="detailView" class="card hide">
      <div class="detailHead">
        <div>
          <div class="iconBig" id="dIcon">üéà</div>
          <div class="title" id="dTitle">Party</div>
          <div class="metaRow">
            <span id="dMeta">‚Äî</span>
            <span id="dType">General</span>
          </div>
        </div>
        <button class="btn secondary" id="homeBtn" aria-label="Go to home">Home</button>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div class="pill" aria-label="Location">
          <strong>üìç</strong> <span id="dLocation">‚Äî</span>
        </div>
        <button class="btn secondary" id="mapsBtn" aria-label="Open location in maps">Maps</button>
      </div>

      <div class="sep"></div>

      <div><strong>Notes:</strong></div>
      <div id="dNotes" class="muted" style="margin-top:6px;">‚Äî</div>

      <div class="sep"></div>

      <div style="font-weight:900;">Items:</div>
      <div class="muted" style="font-size:12px; margin-top:6px;">üëâ Tap an item to claim it</div>
      <ul id="dItems"></ul>

      <div class="sep"></div>

      <div class="row">
        <button class="btn primary" id="editBtn" aria-label="Edit party">Edit</button>
        <button class="btn secondary" id="shareBtn" aria-label="Share party link">Share</button>
      </div>

      <div style="height:10px;"></div>
      <button class="btn secondary" id="moreOptionsBtn" aria-label="More options">More Options</button>

      <div id="moreOptionsPanel" style="display:none; margin-top:10px;">
        <button class="btn secondary" id="copyBtn" aria-label="Copy invite text">Copy Invite Text</button>
        <div style="height:10px;"></div>
        <button class="btn secondary" id="copyLinkBtn" aria-label="Copy invite link">Copy Invite Link</button>
      </div>

      <div class="small" style="margin-top:10px;">
        Sharing tip: use the Share button to generate a link that imports this party.
      </div>
    </div>

    <div id="status" class="status"></div>
  </div>

  <script>
    // ----- Safety net (alerts if JS breaks) -----
    window.addEventListener("error", (e) => {
      alert("JS Error: " + (e.message || "Unknown error"));
    });
    window.addEventListener("unhandledrejection", (e) => {
      alert("Promise Error: " + ((e.reason && e.reason.message) || e.reason || "Unknown promise error"));
    });

    // ---------- Helpers ----------
    const $ = (id) => document.getElementById(id);

    const safeText = (v) => (v == null ? "" : String(v)).trim();

    function setStatus(msg){
      $("status").textContent = msg || "";
      if (msg) setTimeout(() => $("status").textContent = "", 1200);
    }

    function hapticTap(ms = 20){
      // Best-effort only. If the browser blocks vibration, nothing happens (but it won't break the app).
      try{
        if (navigator.vibrate) navigator.vibrate(ms);
      }catch(_){}
    }

    function tapFlash(el){
      if (!el) return;
      const prev = el.style.transform;
      el.style.transform = "scale(0.98)";
      setTimeout(() => { el.style.transform = prev || ""; }, 90);
    }

    const uid = () => Math.random().toString(36).slice(2) + Date.now().toString(36);

    const iconMap = {
      "Birthday":"üéÇ",
      "Game Day":"üèà",
      "Football":"üèà",
      "Baby Shower":"üë∂",
      "Wedding":"üíç",
      "BBQ":"üçñ",
      "Cookout":"üî•",
      "Holiday":"üéÅ",
      "Christmas":"üéÑ",
      "New Years":"üéâ",
      "Beach":"üèñÔ∏è",
      "Pool":"üèä",
      "General":"üéà"
    };

    const STORAGE_KEY = "partyplus_parties_v2";

    const state = {
      parties: [],
      activeId: null
    };

    function saveParties(){
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.parties));
      setStatus("Saved");
    }

    function loadParties(){
      try{
        const raw = localStorage.getItem(STORAGE_KEY);
        state.parties = raw ? JSON.parse(raw) : [];
      }catch(_){
        state.parties = [];
      }
    }

    function normalizeItems(items){
      return (items || []).map(it => {
        if (typeof it === "string") return { text: it, claimedBy: "" };
        return { text: safeText(it.text), claimedBy: safeText(it.claimedBy) };
      }).filter(x => x.text);
    }

    function formatWhen(whenVal){
      if (!whenVal) return "‚Äî";
      const d = new Date(whenVal);
      if (isNaN(d.getTime())) return safeText(whenVal);
      const yyyy = d.getFullYear();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      const hh = String(d.getHours()).padStart(2,"0");
      const mi = String(d.getMinutes()).padStart(2,"0");
      return `${yyyy}-${mm}-${dd} @ ${hh}:${mi}`;
    }

    // ---------- Views ----------
    function show(viewId){
      $("homeView").classList.add("hide");
      $("formView").classList.add("hide");
      $("detailView").classList.add("hide");
      $(viewId).classList.remove("hide");
    }

    // ---------- URL import/export ----------
    function encodeParty(p){
      // Keep it small + safe in URLs
      const payload = {
        v: 1,
        title: safeText(p.title),
        when: safeText(p.when),
        type: safeText(p.type) || "General",
        location: safeText(p.location),
        notes: safeText(p.notes),
        items: normalizeItems(p.items)
      };
      const json = JSON.stringify(payload);
      return btoa(unescape(encodeURIComponent(json)));
    }

    function decodeParty(encoded){
      const json = decodeURIComponent(escape(atob(encoded)));
      return JSON.parse(json);
    }

    function buildShareLink(p){
      const encoded = encodeParty(p);
      const url = new URL(window.location.href);
      url.hash = "";
      url.searchParams.set("p", encoded);
      return url.toString();
    }

    function importFromUrlIfPresent(){
      const url = new URL(window.location.href);
      const encoded = url.searchParams.get("p");
      if (!encoded) return false;

      let payload;
      try{
        payload = decodeParty(encoded);
      }catch(_){
        alert("That invite link looks invalid.");
        return true;
      }

      const newParty = {
        id: uid(),
        title: safeText(payload.title) || "Imported Party",
        when: safeText(payload.when),
        type: safeText(payload.type) || "General",
        location: safeText(payload.location),
        notes: safeText(payload.notes),
        items: normalizeItems(payload.items),
        created: Date.now(),
        updated: Date.now()
      };

      state.parties.unshift(newParty);
      saveParties();
      renderList();
      openParty(newParty.id);

      // Clean URL so it doesn‚Äôt keep importing
      url.searchParams.delete("p");
      history.replaceState({}, "", url.toString());

      setStatus("Imported!");
      return true;
    }

    // ---------- List + Party ----------
    function renderList(){
      const host = $("partyList");
      host.innerHTML = "";

      if (!state.parties.length){
        const empty = document.createElement("div");
        empty.className = "muted";
        empty.textContent = "No parties yet. Tap Create.";
        host.appendChild(empty);
        return;
      }

      state.parties
        .slice()
        .sort((a,b) => (b.updated||0) - (a.updated||0))
        .forEach(p => {
          const btn = document.createElement("button");
          btn.className = "btn secondary";
          btn.style.width = "100%";
          btn.style.marginBottom = "10px";
          const type = safeText(p.type) || "General";
          const icon = iconMap[type] || "üéà";
          btn.textContent = `${icon} ${safeText(p.title) || "Untitled Party"}`;
          btn.setAttribute("aria-label", `Open party ${safeText(p.title) || "Untitled Party"}`);
          btn.onclick = () => {
            hapticTap();
            openParty(p.id);
          };
          host.appendChild(btn);
        });
    }

    function openParty(id){
      const p = state.parties.find(x => x.id === id);
      if (!p) return;

      const type = safeText(p.type) || "General";
      document.body.className = "theme-" + type.replace(/\s+/g,"-");

      state.activeId = id;

      $("dIcon").textContent = iconMap[type] || "üéà";
      $("dTitle").textContent = safeText(p.title) || "Untitled Party";
      $("dMeta").textContent = formatWhen(p.when);
      $("dType").textContent = type;

      $("dLocation").textContent = safeText(p.location) || "‚Äî";
      $("mapsBtn").style.display = p.location ? "block" : "none";

      $("dNotes").textContent = safeText(p.notes) || "‚Äî";

      // Items
      $("dItems").innerHTML = "";
      const items = normalizeItems(p.items);
      p.items = items;

      items.forEach(it => {
        const li = document.createElement("li");
        li.textContent = it.claimedBy ? `${it.text} ‚Äî ${it.claimedBy}` : it.text;

        // Accessibility hint
        li.setAttribute(
  "aria-label",
  it.claimedBy
    ? `${it.text} claimed by ${it.claimedBy}. Double tap to unclaim.`
    : `${it.text}. Not claimed. Double tap to claim.`
);


        li.tabIndex = 0;              // keyboard focus
li.style.cursor = "pointer"; // shows it's clickable

li.onkeydown = (e) => {
  if (e.key === "Enter" || e.key === " ") {
    e.preventDefault();
    li.click();
  }
};

        if (it.claimedBy){
          const badge = document.createElement("span");
          badge.textContent = "CLAIMED";
          badge.style.marginLeft = "8px";
          badge.style.fontSize = "10px";
          badge.style.padding = "2px 6px";
          badge.style.borderRadius = "999px";
          badge.style.background = "#e5e7eb";
          badge.style.color = "#374151";
          badge.style.fontWeight = "600";
          li.appendChild(badge);
        }

        li.onclick = () => {
          tapFlash(li);
          hapticTap();
          toggleClaim(it);
          saveParties();
          openParty(state.activeId);
        };

        $("dItems").appendChild(li);
      });

      show("detailView");
    }

    function toggleClaim(it){
      const current = safeText(it.claimedBy || "");
      const name = safeText(prompt("Who‚Äôs bringing this? (leave blank to unclaim)", current) || "");
      it.claimedBy = name;
      const p = state.parties.find(x => x.id === state.activeId);
      if (p) p.updated = Date.now();
    }

    // ---------- Create/Edit ----------
    function openForm(mode){
      const isEdit = mode === "edit";
      $("formTitle").textContent = isEdit ? "Edit Party" : "Create Party";
      $("deleteBtn").style.display = isEdit ? "inline-block" : "none";

      if (isEdit){
        const p = state.parties.find(x => x.id === state.activeId);
        if (!p) return;
        $("fTitle").value = safeText(p.title);
        $("fWhen").value = safeText(p.when);
        $("fType").value = safeText(p.type) || "General";
        $("fLocation").value = safeText(p.location);
        $("fNotes").value = safeText(p.notes);
        $("fItems").value = normalizeItems(p.items).map(x => x.text).join("\n");
      }else{
        state.activeId = null;
        $("fTitle").value = "";
        $("fWhen").value = "";
        $("fType").value = "General";
        $("fLocation").value = "";
        $("fNotes").value = "";
        $("fItems").value = "";
      }

      show("formView");
    }

    function saveParty(){
      const title = safeText($("fTitle").value);
      const when = safeText($("fWhen").value);
      const type = safeText($("fType").value) || "General";
      const location = safeText($("fLocation").value);
      const notes = safeText($("fNotes").value);
      const items = normalizeItems(
        safeText($("fItems").value)
          .split("\n")
          .map(s => s.trim())
          .filter(Boolean)
      );

      if (!title){
        alert("Give it a title (even just 'Friday night').");
        return;
      }

      if (state.activeId){
        const p = state.parties.find(x => x.id === state.activeId);
        if (!p) return;
        p.title = title;
        p.when = when;
        p.type = type;
        p.location = location;
        p.notes = notes;
        // keep claims if possible by matching text
        const old = normalizeItems(p.items);
        const next = items.map(n => {
          const found = old.find(o => o.text.toLowerCase() === n.text.toLowerCase());
          return found ? { text: n.text, claimedBy: found.claimedBy } : { text: n.text, claimedBy: "" };
        });
        p.items = next;
        p.updated = Date.now();
        saveParties();
        renderList();
        openParty(p.id);
        return;
      }

      const p = {
        id: uid(),
        title, when, type, location, notes,
        items,
        created: Date.now(),
        updated: Date.now()
      };

      state.parties.unshift(p);
      saveParties();
      renderList();
      openParty(p.id);
    }

    function deleteParty(){
      if (!state.activeId) return;
      const p = state.parties.find(x => x.id === state.activeId);
      const name = p ? (p.title || "this party") : "this party";
      if (!confirm(`Delete "${name}"?`)) return;

      state.parties = state.parties.filter(x => x.id !== state.activeId);
      state.activeId = null;
      saveParties();
      renderList();
      show("homeView");
    }

    function resetAll(){
      if (!confirm("Reset ALL parties on this device?")) return;
      localStorage.removeItem(STORAGE_KEY);
      state.parties = [];
      state.activeId = null;
      renderList();
      show("homeView");
      setStatus("Reset");
    }

    // ---------- Share / Copy / Maps ----------
    async function copyToClipboard(text){
      try{
        await navigator.clipboard.writeText(text);
        setStatus("Copied");
        return true;
      }catch(_){
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        try{ document.execCommand("copy"); setStatus("Copied"); }
        catch(e){ alert("Could not copy on this browser."); }
        finally{ document.body.removeChild(ta); }
        return false;
      }
    }

    function inviteText(p){
      const title = safeText(p.title) || "Party";
      const when = formatWhen(p.when);
      const where = safeText(p.location) ? `\nüìç ${safeText(p.location)}` : "";
      const link = buildShareLink(p);
     return `üéâ ${title}\nüóìÔ∏è ${when}${where}\n\nTap to open in PartyPlus:\n ${link}`;

    }

    async function shareParty(){
      const p = state.parties.find(x => x.id === state.activeId);
      if (!p) return;
      const link = buildShareLink(p);
      const text = inviteText(p);

      if (navigator.share){
        try{
          await navigator.share({ title: p.title || "PartyPlus", text, url: link });
          setStatus("Shared");
          return;
        }catch(_){}
      }
      // fallback: copy link
      await copyToClipboard(link);
      alert("Share isn‚Äôt available here, so I copied the invite link.");
    }

    function openMaps(){
      const p = state.parties.find(x => x.id === state.activeId);
      if (!p || !p.location) return;
      const q = encodeURIComponent(p.location);
      window.open(`https://www.google.com/maps/search/?api=1&query=${q}`, "_blank");
    }

    // ---------- Wire up ----------
    document.addEventListener("DOMContentLoaded", () => {
      console.log("DOM LOADED");

      loadParties();
      importFromUrlIfPresent();
      renderList();
      show("homeView");

      $("createBtn").onclick = () => { hapticTap(); openForm("create"); };
      $("resetBtn").onclick = () => resetAll();

      $("cancelFormBtn").onclick = () => { hapticTap(); show("homeView"); };
      $("saveBtn").onclick = () => saveParty();
      $("deleteBtn").onclick = () => deleteParty();

      $("homeBtn").onclick = () => { hapticTap(); show("homeView"); };
      $("editBtn").onclick = () => { hapticTap(); openForm("edit"); };

      $("mapsBtn").onclick = () => openMaps();
      $("shareBtn").onclick = () => shareParty();

      $("moreOptionsBtn").onclick = () => {
        const panel = $("moreOptionsPanel");
        panel.style.display = panel.style.display === "none" ? "block" : "none";
      };

      $("copyBtn").onclick = async () => {
        const p = state.parties.find(x => x.id === state.activeId);
        if (!p) return;
        await copyToClipboard(inviteText(p));
      };

      $("copyLinkBtn").onclick = async () => {
        const p = state.parties.find(x => x.id === state.activeId);
        if (!p) return;
        await copyToClipboard(buildShareLink(p));
      };
    });
  </script>
</body>
</html>
