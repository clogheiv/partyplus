<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>PartyPlus</title>
  <style>
/* Party Themes */
.theme-General { background: #f6f7fb; }
.theme-BBQ { background: linear-gradient(135deg,#ff7043,#ffca28); }
.theme-Birthday { background: linear-gradient(135deg,#ab47bc,#ec407a); }
.theme-Holiday { background: linear-gradient(135deg,#2e7d32,#26a69a); }
.theme-Game\ Day { background: linear-gradient(135deg,#fbc02d,#000); }
.theme-Wedding { background: linear-gradient(135deg,#f8bbd0,#ffffff); }
.theme-Potluck { background: linear-gradient(135deg,#8d6e63,#d7ccc8); }

/* the rest of your existing CSS stays below this */
    :root { --pad: 14px; --radius: 14px; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:#f6f7fb; color:#111; }
    header { background:#111; color:#fff; padding:16px var(--pad); position:sticky; top:0; z-index:10; }
    header h1 { margin:0; font-size:18px; letter-spacing:.3px; }
    main { padding: var(--pad); max-width: 820px; margin:0 auto; }
    .card { background:#fff; border-radius: var(--radius); box-shadow:0 6px 22px rgba(0,0,0,.06); padding: var(--pad); margin:12px 0; }
    .row { display:grid; grid-template-columns:1fr; gap:10px; }
    @media (min-width:720px){ .row.two{ grid-template-columns:1fr 1fr; } }
    label { font-size:12px; color:#444; display:block; margin-bottom:6px; }
    input, textarea, select, button { width:100%; box-sizing:border-box; padding:12px; border-radius:12px; border:1px solid #d7dbe7; font-size:15px; background:#fff; }
    textarea { min-height:90px; resize:vertical; }
    button { border:0; cursor:pointer; font-weight:650; background:#111; color:#fff; }
    button.secondary { background:#e9ecf6; color:#111; }
    button.danger { background:#c62828; }
    .btnRow { display:grid; grid-template-columns:1fr; gap:10px; }
    @media (min-width:540px){ .btnRow{ grid-template-columns:repeat(3,1fr); } }
    .pill { display:inline-block; padding:6px 10px; border-radius:999px; background:#eef2ff; color:#1a2a7a; font-size:12px; margin-right:8px; }
    .partyItem { display:grid; grid-template-columns:1fr auto; gap:10px; align-items:center; padding:12px; border-radius:14px; border:1px solid #e7e9f2; margin:10px 0; background:#fff; }
    .partyItem h3 { margin:0 0 4px 0; font-size:16px; }
    .muted { color:#555; font-size:13px; }
    .linkBtn { width:auto; padding:10px 12px; border-radius:12px; }
    .sep { height:1px; background:#eceef7; margin:12px 0; }
    .small { font-size:12px; color:#666; }
    .hide { display:none !important; }
    .toast {
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background:rgba(17,17,17,.92); color:#fff; padding:10px 14px;
      border-radius:999px; font-size:13px; z-index:9999;
      box-shadow:0 10px 30px rgba(0,0,0,.25);
    }
  </style>
</head>
<body>
  <header><h1>PartyPlus</h1></header>

  <main>
    <section id="homeView" class="card">
      <div class="row">
        <div>
          <span class="pill" id="partyCountPill">0 Parties</span>
          <span class="pill" id="storagePill">Saved</span>
        </div>

        <div class="btnRow">
          <button id="createPartyBtn">Create a Party</button>
          <button class="secondary" id="importBtn">Import</button>
          <button class="secondary" id="exportBtn">Export</button>
        </div>

        <div class="sep"></div>

        <div>
          <label for="searchBox">Search parties</label>
          <input id="searchBox" placeholder="Type to filter..." />
        </div>

        <div id="partyList"></div>

        <div class="sep"></div>

        <button class="danger" id="resetBtn">Reset All Parties</button>
        <div class="small" style="margin-top:10px;">
          Tip: Sharing works by embedding party info in the link (no accounts needed).
        </div>
      </div>
    </section>

    <section id="editView" class="card hide">
      <h2 id="editTitle" style="margin:0 0 10px 0; font-size:18px;">Create Party</h2>

      <div class="row two">
        <div>
          <label for="pTitle">Party name</label>
          <input id="pTitle" placeholder="e.g., Ashley’s Birthday" />
        </div>
        <div>
          <label for="pType">Type</label>
          <select id="pType">
            <option value="General">General</option>
            <option value="Birthday">Birthday</option>
            <option value="Holiday">Holiday</option>
            <option value="BBQ">BBQ</option>
            <option value="Game Day">Game Day</option>
            <option value="Wedding">Wedding</option>
            <option value="Potluck">Potluck</option>
          </select>
        </div>
      </div>

      <div class="row two">
        <div>
          <label for="pDate">Date</label>
          <input id="pDate" type="date" />
        </div>
        <div>
          <label for="pTime">Time</label>
          <input id="pTime" type="time" />
        </div>
      </div>

      <div class="row">
        <div>
          <label for="pLocation">Location</label>
          <input id="pLocation" placeholder="e.g., Clogher HQ / Backyard" />
        </div>
        <div>
          <label for="pNotes">Notes</label>
          <textarea id="pNotes" placeholder="Anything guests should know..."></textarea>
        </div>
      </div>

      <div class="row two">
        <div>
          <label for="itemInput">Add item</label>
          <input id="itemInput" placeholder="e.g., Ice, Plates, Soda..." />
        </div>
        <div style="display:flex; gap:10px; align-items:end;">
          <button class="secondary linkBtn" id="addItemBtn" style="flex:1;">Add Item</button>
          <button class="secondary linkBtn" id="clearItemsBtn" style="flex:1;">Clear Items</button>
        </div>
      </div>

      <div id="itemsList" class="small" style="margin-top:8px;"></div>

      <div class="sep"></div>

      <div class="btnRow">
        <button id="saveBtn">Save</button>
        <button class="secondary" id="cancelBtn">Back</button>
        <button class="danger" id="deleteBtn">Delete</button>
      </div>
    </section>

    <section id="detailView" class="card hide">
      <div style="display:flex; justify-content:space-between; align-items:start; gap:10px;">
        <div>
          <h2 id="dTitle" style="margin:0 0 6px 0; font-size:18px;"></h2>
          <div class="muted" id="dMeta"></div>
        </div>
        <button class="secondary linkBtn" id="backHomeBtn" style="width:auto;">Home</button>
      </div>

      <div class="sep"></div>

      <div class="row">
        <div>
          <div class="pill" id="dType"></div>
          <div style="height:8px;"></div>
          <div><strong>Location:</strong> <span id="dLocation"></span></div>
          <div style="margin-top:8px;"><strong>Notes:</strong></div>
          <div id="dNotes" class="muted" style="white-space:pre-wrap;"></div>
        </div>

        <div class="sep"></div>

        <div>
          <strong>Items:</strong>
          <div id="dItems" class="muted" style="margin-top:8px; white-space:pre-wrap;"></div>
        </div>

        <div class="sep"></div>

        <div class="btnRow">
          <button id="editBtn">Edit</button>
          <button class="secondary" id="shareBtn">Share</button>
          <button class="secondary" id="copyBtn">Copy Invite Text</button>
        </div>

        <div class="small" id="shareHelp" style="margin-top:10px;"></div>
      </div>
    </section>

    <input id="filePicker" type="file" accept="application/json" class="hide" />
  </main>

  <script>
    const STORAGE_KEY = "partyplus_parties_v1";
    const $ = (id) => document.getElementById(id);

    const views = { home: $("homeView"), edit: $("editView"), detail: $("detailView") };

    const state = { parties: [], activeId: null, editingId: null, itemsDraft: [] };

    function toast(msg) {
      const t = document.createElement("div");
      t.className = "toast";
      t.textContent = msg;
      document.body.appendChild(t);
      setTimeout(() => t.remove(), 1800);
    }

    function uid() { return "p_" + Math.random().toString(16).slice(2) + "_" + Date.now().toString(16); }
    function safeText(v) { return (v ?? "").toString().trim(); }

    function showView(name) {
      Object.values(views).forEach(v => v.classList.add("hide"));
      views[name].classList.remove("hide");
      window.scrollTo({ top: 0, behavior: "smooth" });
    }

    function saveToStorage() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state.parties));
      updatePills();
    }

    function loadFromStorage() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        state.parties = raw ? JSON.parse(raw) : [];
        if (!Array.isArray(state.parties)) state.parties = [];
      } catch {
        state.parties = [];
      }

      if (state.parties.length === 0) {
        state.parties = [{
          id: uid(),
          title: "Chrome Test Party",
          type: "General",
          date: "",
          time: "",
          location: "",
          notes: "This is a demo party. Create your own and delete this one when you're ready.",
          items: ["Ice", "Cups", "Napkins"],
          createdAt: Date.now()
        }];
        saveToStorage();
      }
    }

    function updatePills() {
      $("partyCountPill").textContent = `${state.parties.length} Parties`;
      $("storagePill").textContent = localStorage.getItem(STORAGE_KEY) ? "Saved" : "Not Saved";
    }

    function formatDateTime(p) {
      const d = safeText(p.date);
      const t = safeText(p.time);
      if (!d && !t) return "No date/time set";
      if (d && !t) return d;
      if (!d && t) return t;
      return `${d} @ ${t}`;
    }

    function renderList(filter = "") {
      const q = safeText(filter).toLowerCase();
      const list = $("partyList");
      list.innerHTML = "";

      const sorted = [...state.parties].sort((a,b) => (b.createdAt||0) - (a.createdAt||0));
      const shown = sorted.filter(p => {
        if (!q) return true;
        return (
          safeText(p.title).toLowerCase().includes(q) ||
          safeText(p.type).toLowerCase().includes(q) ||
          safeText(p.location).toLowerCase().includes(q)
        );
      });

      if (shown.length === 0) {
        const empty = document.createElement("div");
        empty.className = "muted";
        empty.textContent = "No parties found.";
        list.appendChild(empty);
        return;
      }

      shown.forEach(p => {
        const item = document.createElement("div");
        item.className = "partyItem";

        const left = document.createElement("div");
        const h = document.createElement("h3");
        h.textContent = safeText(p.title) || "(Untitled Party)";
        const m = document.createElement("div");
        m.className = "muted";
        m.textContent = `${p.type || "General"} • ${formatDateTime(p)}`;
        left.appendChild(h);
        left.appendChild(m);

        const btn = document.createElement("button");
        btn.className = "secondary linkBtn";
        btn.textContent = "Open";
        btn.addEventListener("click", () => openParty(p.id));

        item.appendChild(left);
        item.appendChild(btn);
        list.appendChild(item);
      });
    }

    function openParty(id) {
      const p = state.parties.find(x => x.id === id);
      if (!p) return;

      state.activeId = id;

      $("dTitle").textContent = safeText(p.title) || "(Untitled Party)";
      $("dMeta").textContent = formatDateTime(p);
      $("dType").textContent = p.type || "General";
      $("dLocation").textContent = safeText(p.location) || "—";
      $("dNotes").textContent = safeText(p.notes) || "—";

      const items = Array.isArray(p.items) ? p.items : [];
      $("dItems").textContent = items.length ? items.map(x => `• ${x}`).join("\n") : "—";

      $("shareHelp").textContent = `Sharing tip: use the Share button to generate a link that imports this party.`;
      showView("detail");
    }

    function startCreate() {
      state.editingId = null;
      state.itemsDraft = [];
      $("editTitle").textContent = "Create Party";
      $("deleteBtn").classList.add("hide");

      $("pTitle").value = "";
      $("pType").value = "General";
      $("pDate").value = "";
      $("pTime").value = "";
      $("pLocation").value = "";
      $("pNotes").value = "";
      $("itemInput").value = "";
      renderItemsDraft();

      showView("edit");
    }

    function startEdit(id) {
      const p = state.parties.find(x => x.id === id);
      if (!p) return;

      state.editingId = id;
      $("editTitle").textContent = "Edit Party";
      $("deleteBtn").classList.remove("hide");

      $("pTitle").value = safeText(p.title);
      $("pType").value = p.type || "General";
      $("pDate").value = safeText(p.date);
      $("pTime").value = safeText(p.time);
      $("pLocation").value = safeText(p.location);
      $("pNotes").value = safeText(p.notes);

      state.itemsDraft = Array.isArray(p.items) ? [...p.items] : [];
      $("itemInput").value = "";
      renderItemsDraft();

      showView("edit");
    }

    function renderItemsDraft() {
      const box = $("itemsList");
      if (state.itemsDraft.length === 0) { box.textContent = "No items yet."; return; }
      box.textContent = state.itemsDraft.map((x,i) => `${i+1}. ${x}`).join("\n");
    }

    function addItem() {
      const v = safeText($("itemInput").value);
      if (!v) return;
      state.itemsDraft.push(v);
      $("itemInput").value = "";
      renderItemsDraft();
    }

    function clearItems() {
      state.itemsDraft = [];
      renderItemsDraft();
      toast("Items cleared");
    }

    function upsertParty() {
      const data = {
        title: safeText($("pTitle").value),
        type: $("pType").value || "General",
        date: safeText($("pDate").value),
        time: safeText($("pTime").value),
        location: safeText($("pLocation").value),
        notes: safeText($("pNotes").value),
        items: [...state.itemsDraft],
      };

      if (!data.title) { toast("Give it a party name first"); $("pTitle").focus(); return; }

      if (state.editingId) {
        const idx = state.parties.findIndex(x => x.id === state.editingId);
        if (idx >= 0) state.parties[idx] = { ...state.parties[idx], ...data };
      } else {
        state.parties.unshift({ id: uid(), ...data, createdAt: Date.now() });
      }

      saveToStorage();
      renderList($("searchBox").value);
      toast("Saved");

      const openId = state.editingId ? state.editingId : state.parties[0].id;
      state.editingId = null;
      openParty(openId);
    }

    function deleteParty() {
      if (!state.editingId) return;
      const id = state.editingId;
      state.parties = state.parties.filter(p => p.id !== id);
      state.editingId = null;
      saveToStorage();
      renderList($("searchBox").value);
      toast("Deleted");
      showView("home");
    }

    function resetAll() {
      if (!confirm("Reset ALL parties? This cannot be undone.")) return;
      localStorage.removeItem(STORAGE_KEY);
      state.parties = [];
      loadFromStorage();
      renderList("");
      showView("home");
      toast("Reset done");
    }

    async function copyText(text) {
      try { await navigator.clipboard.writeText(text); }
      catch {
        const ta = document.createElement("textarea");
        ta.value = text; document.body.appendChild(ta);
        ta.select(); document.execCommand("copy"); ta.remove();
      }
    }

    function exportData() {
      const data = JSON.stringify(state.parties, null, 2);
      const blob = new Blob([data], { type: "application/json" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url; a.download = "partyplus-backup.json"; a.click();
      setTimeout(() => URL.revokeObjectURL(url), 800);
      toast("Exporting backup");
    }

    function importData(file) {
      const reader = new FileReader();
      reader.onload = () => {
        try {
          const parsed = JSON.parse(reader.result);
          if (!Array.isArray(parsed)) throw new Error("Not an array");
          state.parties = parsed.map(p => ({
            id: p.id || uid(),
            title: safeText(p.title),
            type: p.type || "General",
            date: safeText(p.date),
            time: safeText(p.time),
            location: safeText(p.location),
            notes: safeText(p.notes),
            items: Array.isArray(p.items) ? p.items.map(x => safeText(x)).filter(Boolean) : [],
            createdAt: p.createdAt || Date.now()
          }));
          saveToStorage();
          renderList("");
          toast("Imported");
        } catch {
          alert("Import failed. Make sure you selected a PartyPlus backup JSON file.");
        }
      };
      reader.readAsText(file);
    }

    // --- Share link that imports party data (works across devices) ---
    function encodePartyData(p) {
      const payload = {
        title: safeText(p.title),
        type: p.type || "General",
        date: safeText(p.date),
        time: safeText(p.time),
        location: safeText(p.location),
        notes: safeText(p.notes),
        items: Array.isArray(p.items) ? p.items : []
      };
      const json = JSON.stringify(payload);
      const b64 = btoa(unescape(encodeURIComponent(json)))
        .replace(/\+/g, "-").replace(/\//g, "_").replace(/=+$/g, "");
      return b64;
    }

    function shareLinkForParty(p) {
      const base = `${window.location.origin}${window.location.pathname}`;
      return `${base}?d=${encodePartyData(p)}`;
    }

    function inviteTextForParty(p) {
      const title = safeText(p.title) || "Party";
      const type = p.type || "General";
      const when = formatDateTime(p);
      const where = safeText(p.location) || "—";
      const notes = safeText(p.notes) || "—";
      const items = (Array.isArray(p.items) && p.items.length) ? p.items.map(x => `- ${x}`).join("\n") : "- (none yet)";
      const link = shareLinkForParty(p);

      return (
`You're invited: ${title}
Type: ${type}
When: ${when}
Where: ${where}

Notes:
${notes}

Items:
${items}

Open PartyPlus here:
${link}`
      );
    }

    function decodePartyData(d) {
      try {
        const b64 = d.replace(/-/g, "+").replace(/_/g, "/") + "===".slice((d.length + 3) % 4);
        const json = decodeURIComponent(escape(atob(b64)));
        const payload = JSON.parse(json);

        return {
          title: safeText(payload.title),
          type: payload.type || "General",
          date: safeText(payload.date),
          time: safeText(payload.time),
          location: safeText(payload.location),
          notes: safeText(payload.notes),
          items: Array.isArray(payload.items) ? payload.items.map(x => safeText(x)).filter(Boolean) : []
        };
      } catch {
        return null;
      }
    }

    // Wire up UI
    $("createPartyBtn").addEventListener("click", startCreate);
    $("cancelBtn").addEventListener("click", () => showView("home"));
    $("saveBtn").addEventListener("click", upsertParty);
    $("deleteBtn").addEventListener("click", deleteParty);

    $("editBtn").addEventListener("click", () => startEdit(state.activeId));
    $("backHomeBtn").addEventListener("click", () => showView("home"));

    $("addItemBtn").addEventListener("click", addItem);
    $("clearItemsBtn").addEventListener("click", clearItems);

    $("shareBtn").addEventListener("click", async () => {
      const p = state.parties.find(x => x.id === state.activeId);
      if (!p) return;
      const text = inviteTextForParty(p);

      if (navigator.share) {
        try {
          await navigator.share({ title: p.title || "PartyPlus Invite", text, url: shareLinkForParty(p) });
          toast("Shared");
          return;
        } catch {}
      }

      await copyText(text);
      toast("Invite copied");
    });

    $("copyBtn").addEventListener("click", async () => {
      const p = state.parties.find(x => x.id === state.activeId);
      if (!p) return;
      await copyText(inviteTextForParty(p));
      toast("Invite copied");
    });

    $("resetBtn").addEventListener("click", resetAll);
    $("searchBox").addEventListener("input", (e) => renderList(e.target.value));

    $("exportBtn").addEventListener("click", exportData);
    $("importBtn").addEventListener("click", () => $("filePicker").click());
    $("filePicker").addEventListener("change", (e) => {
      const file = e.target.files && e.target.files[0];
      if (file) importData(file);
      e.target.value = "";
    });

    // Boot
    loadFromStorage();
    updatePills();
    renderList("");

    const params = new URLSearchParams(window.location.search);
    const d = params.get("d");

    if (d) {
      const payload = decodePartyData(d);
      if (payload && payload.title) {
        const newId = uid();
        state.parties.unshift({ id: newId, ...payload, createdAt: Date.now() });
        saveToStorage();
        renderList("");
        openParty(newId);
        toast("Party imported from link");
      } else {
        showView("home");
        toast("Invalid party link");
      }
    } else {
      showView("home");
    }
  </script>
</body>
</html>