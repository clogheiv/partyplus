<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>PartyPlus</title>

  <link rel="manifest" href="./manifest.json">
  <meta name="theme-color" content="#111827" />

  <style>
    :root{
      --bg:#0b1220;
      --card:#101a33;
      --card2:#0f1730;
      --text:#e5e7eb;
      --muted:#9ca3af;
      --line:rgba(255,255,255,.10);
      --accent:#60a5fa;
      --good:#22c55e;
      --bad:#ef4444;
      --btn:#1f2a4a;
      --btn2:#1a2441;
      --shadow:0 12px 32px rgba(0,0,0,.35);
      --radius:16px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;
      background: radial-gradient(1000px 600px at 20% 0%, rgba(96,165,250,.18), transparent 55%),
                  radial-gradient(900px 700px at 90% 20%, rgba(34,197,94,.12), transparent 55%),
                  var(--bg);
      color:var(--text);
    }
    header{
      position:sticky; top:0; z-index:10;
      backdrop-filter: blur(10px);
      background: rgba(11,18,32,.75);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:980px;margin:0 auto;padding:14px 14px}
    .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
    .title{font-weight:800;letter-spacing:.2px;font-size:18px}
    .pill{
      padding:6px 10px;border:1px solid var(--line);border-radius:999px;
      color:var(--muted);font-size:12px;background:rgba(255,255,255,.04)
    }
    main{max-width:980px;margin:0 auto;padding:16px 14px 80px}
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .cardPad{padding:14px}
    .grid{display:grid;gap:12px}
    @media(min-width:860px){
      .grid{grid-template-columns: 360px 1fr; align-items:start}
    }
    label{display:block;font-size:12px;color:var(--muted);margin:10px 0 6px}
    input, textarea, select{
      width:100%;
      padding:12px 12px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
    }
    textarea{min-height:120px;resize:vertical}
    .btn{
      appearance:none;border:1px solid var(--line);
      background: var(--btn);
      color: var(--text);
      padding:11px 12px;border-radius:12px;
      font-weight:700;
      cursor:pointer;
      user-select:none;
    }
    .btn:active{transform:translateY(1px)}
    .btn.primary{background: linear-gradient(180deg, rgba(96,165,250,.22), rgba(96,165,250,.10)); border-color: rgba(96,165,250,.35)}
    .btn.good{background: linear-gradient(180deg, rgba(34,197,94,.22), rgba(34,197,94,.10)); border-color: rgba(34,197,94,.35)}
    .btn.bad{background: linear-gradient(180deg, rgba(239,68,68,.22), rgba(239,68,68,.10)); border-color: rgba(239,68,68,.35)}
    .btn.ghost{background: rgba(255,255,255,.04)}
    .btnRow{display:flex;gap:10px;flex-wrap:wrap}
    .muted{color:var(--muted)}
    .list{margin:0;padding:0;list-style:none}
    .item{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      padding:12px 12px;border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius:14px;
      cursor:pointer;
    }
    .item:hover{background: rgba(0,0,0,.26)}
    .itemTitle{font-weight:800}
    .itemMeta{font-size:12px;color:var(--muted);margin-top:2px}
    .right{display:flex;gap:8px;align-items:center}
    .badge{
      font-size:11px;color:var(--muted);
      border:1px solid var(--line);
      padding:5px 8px;border-radius:999px;
      background: rgba(255,255,255,.04);
    }
    .divider{height:1px;background:var(--line);margin:12px 0}
    .toast{
      position:fixed; left:50%; bottom:20px; transform:translateX(-50%);
      background: rgba(0,0,0,.78);
      border: 1px solid rgba(255,255,255,.18);
      color: var(--text);
      padding:10px 12px;border-radius:999px;
      font-weight:700;font-size:13px;
      opacity:0; pointer-events:none;
      transition: opacity .18s ease;
      max-width:min(92vw, 620px);
      white-space:nowrap;
      overflow:hidden;text-overflow:ellipsis;
    }
    .toast.show{opacity:1}
    .small{font-size:12px}
    .hint{font-size:12px;color:var(--muted);line-height:1.35}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, monospace}
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="row" style="justify-content:space-between">
      <div class="row">
        <div class="title">PartyPlus</div>
        <div id="statusPill" class="pill">Ready</div>
      </div>
      <div class="row">
        <button id="homeBtn" class="btn ghost">Home</button>
        <button id="installBtn" class="btn primary" style="display:none">Install</button>
      </div>
    </div>
  </div>
</header>

<main>
  <div class="grid">
    <!-- LEFT: Home -->
    <section id="homeView" class="card">
      <div class="cardPad">
        <div class="row" style="justify-content:space-between;align-items:flex-end">
          <div>
            <div style="font-weight:900;font-size:16px">Your Parties</div>
            <div class="hint">Create one, tap to open, then hit <b>Share Party</b>.</div>
          </div>
          <div class="badge" id="countBadge">0</div>
        </div>

        <div class="divider"></div>

        <label for="newName">Party name</label>
        <input id="newName" placeholder="e.g., Super Bowl, Birthday, BBQ..." />

        <div class="btnRow" style="margin-top:10px">
          <button id="createBtn" class="btn good">Create Party</button>
          <button id="resetAllBtn" class="btn bad">Reset All</button>
        </div>

        <div class="divider"></div>

        <label for="search">Search</label>
        <input id="search" placeholder="Search parties..." />

        <label for="sort">Sort</label>
        <select id="sort">
          <option value="newest">Newest</option>
          <option value="oldest">Oldest</option>
          <option value="name">Name</option>
        </select>

        <div class="divider"></div>

        <ul id="partyList" class="list" style="display:grid;gap:10px;margin-top:10px"></ul>

        <div class="divider"></div>
        <div class="hint small">
          Tip: shared links look like
          <span class="mono">partyplus.html?party=YOUR_ID</span>.
        </div>
      </div>
    </section>

    <!-- RIGHT: Party -->
    <section id="partyView" class="card" style="display:none">
      <div class="cardPad">
        <div class="row" style="justify-content:space-between">
          <div>
            <div id="partyTitle" style="font-weight:950;font-size:18px">Party</div>
            <div id="partyIdLine" class="hint mono"></div>
          </div>
          <div class="btnRow">
            <button id="shareBtn" class="btn primary">Share Party</button>
            <button id="deleteBtn" class="btn bad">Delete</button>
          </div>
        </div>

        <div class="divider"></div>

        <label for="type">Type</label>
        <input id="type" placeholder="Birthday, Holiday, BBQ..." />

        <div class="row" style="gap:12px">
          <div style="flex:1">
            <label for="date">Date</label>
            <input id="date" type="date" />
          </div>
          <div style="flex:1">
            <label for="time">Time</label>
            <input id="time" type="time" />
          </div>
        </div>

        <label for="location">Location</label>
        <input id="location" placeholder="Address or place name" />

        <label for="notes">Notes</label>
        <textarea id="notes" placeholder="Agenda, what to bring, who’s bringing what..."></textarea>

        <div class="btnRow" style="margin-top:10px">
          <button id="saveBtn" class="btn good">Save</button>
          <button id="copyLinkBtn" class="btn">Copy Link</button>
        </div>

        <div class="divider"></div>

        <div class="hint">
          If someone opens your link and the party isn’t found, they’ll see a message.
          (They won’t get a blank screen.)
        </div>
      </div>
    </section>
  </div>
</main>

<div id="toast" class="toast"></div>

<script>
(() => {
  "use strict";

  // ====== Storage ======
  const STORAGE_KEY = "partyplus_v3_parties";
  const $ = (id) => document.getElementById(id);

  // ====== UI ======
  const statusPill = $("statusPill");
  const toastEl = $("toast");

  const homeView = $("homeView");
  const partyView = $("partyView");

  const partyListEl = $("partyList");
  const countBadge = $("countBadge");
  const searchEl = $("search");
  const sortEl = $("sort");

  const newNameEl = $("newName");
  const createBtn = $("createBtn");
  const resetAllBtn = $("resetAllBtn");
  const homeBtn = $("homeBtn");

  const partyTitle = $("partyTitle");
  const partyIdLine = $("partyIdLine");
  const typeEl = $("type");
  const dateEl = $("date");
  const timeEl = $("time");
  const locationEl = $("location");
  const notesEl = $("notes");

  const saveBtn = $("saveBtn");
  const deleteBtn = $("deleteBtn");
  const shareBtn = $("shareBtn");
  const copyLinkBtn = $("copyLinkBtn");

  // ====== State ======
  let parties = [];
  let currentId = null;
  let installPromptEvent = null;

  function setStatus(text) {
    statusPill.textContent = text;
  }

  function toast(msg) {
    toastEl.textContent = msg;
    toastEl.classList.add("show");
    setTimeout(() => toastEl.classList.remove("show"), 1700);
  }

  // On-screen crash reporting (prevents "dead buttons" mystery)
  window.addEventListener("error", (e) => {
    try { toast("JS error: " + (e.message || "unknown")); } catch(_) {}
  });
  window.addEventListener("unhandledrejection", (e) => {
    try { toast("Promise error: " + (e.reason?.message || e.reason || "unknown")); } catch(_) {}
  });

  function loadParties() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      const parsed = raw ? JSON.parse(raw) : [];
      parties = Array.isArray(parsed) ? parsed : [];
    } catch {
      parties = [];
    }
  }

  function saveParties() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(parties));
    setStatus("Saved");
    setTimeout(() => setStatus("Ready"), 900);
  }

  function uid() {
    // Short but unique enough for this app
    return "p_" + Math.random().toString(36).slice(2, 8) + Date.now().toString(36).slice(3);
  }

  function formatMeta(p) {
    const bits = [];
    if (p.type) bits.push(p.type);
    if (p.date) bits.push(p.date);
    if (p.time) bits.push(p.time);
    if (p.location) bits.push(p.location);
    return bits.join(" • ");
  }

  function getFilteredSorted() {
    const q = (searchEl.value || "").trim().toLowerCase();
    let list = parties.slice();
    if (q) {
      list = list.filter(p => {
        const blob = `${p.name||""} ${p.type||""} ${p.location||""} ${p.notes||""}`.toLowerCase();
        return blob.includes(q);
      });
    }

    const sort = sortEl.value;
    if (sort === "newest") list.sort((a,b) => (b.createdAt||"").localeCompare(a.createdAt||""));
    else if (sort === "oldest") list.sort((a,b) => (a.createdAt||"").localeCompare(b.createdAt||""));
    else if (sort === "name") list.sort((a,b) => (a.name||"").localeCompare(b.name||""));

    return list;
  }

  function renderPartyList() {
    const list = getFilteredSorted();
    countBadge.textContent = String(list.length);
    partyListEl.innerHTML = "";

    if (!list.length) {
      const li = document.createElement("li");
      li.className = "hint";
      li.textContent = "No parties yet. Create one above.";
      partyListEl.appendChild(li);
      return;
    }

    for (const p of list) {
      const li = document.createElement("li");
      li.className = "item";
      li.setAttribute("role","button");
      li.tabIndex = 0;

      const left = document.createElement("div");
      const t = document.createElement("div");
      t.className = "itemTitle";
      t.textContent = p.name || "(Untitled)";
      const m = document.createElement("div");
      m.className = "itemMeta";
      m.textContent = formatMeta(p) || "Tap to open";
      left.appendChild(t);
      left.appendChild(m);

      const right = document.createElement("div");
      right.className = "right";
      const b = document.createElement("div");
      b.className = "badge mono";
      b.textContent = (p.id || "").slice(-6);
      right.appendChild(b);

      li.appendChild(left);
      li.appendChild(right);

      li.addEventListener("click", () => openParty(p.id));
      li.addEventListener("keydown", (e) => {
        if (e.key === "Enter" || e.key === " ") openParty(p.id);
      });

      partyListEl.appendChild(li);
    }
  }

  function showHome() {
    partyView.style.display = "none";
    homeView.style.display = "block";
    currentId = null;
    history.replaceState(null, "", "./partyplus.html");
    setStatus("Ready");
  }

  function showParty() {
    homeView.style.display = "none";
    partyView.style.display = "block";
  }

  function getParty(id) {
    return parties.find(p => p.id === id) || null;
  }

  function openParty(id) {
    const p = getParty(id);
    if (!p) {
      toast("Party not found.");
      showHome();
      return;
    }
    currentId = id;

    partyTitle.textContent = p.name || "Party";
    partyIdLine.textContent = `ID: ${p.id}`;

    typeEl.value = p.type || "";
    dateEl.value = p.date || "";
    timeEl.value = p.time || "";
    locationEl.value = p.location || "";
    notesEl.value = p.notes || "";

    // Put the shareable URL in the address bar
    const url = new URL(window.location.href);
    url.searchParams.set("party", p.id);
    history.replaceState(null, "", url.toString());

    showParty();
  }

  function createParty() {
    const name = (newNameEl.value || "").trim();
    if (!name) {
      toast("Enter a party name.");
      newNameEl.focus();
      return;
    }

    const p = {
      id: uid(),
      name,
      type: "",
      date: "",
      time: "",
      location: "",
      notes: "",
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString(),
    };

    parties.unshift(p);
    saveParties();
    newNameEl.value = "";
    renderPartyList();
    toast("Party created");
    openParty(p.id);
  }

  function saveCurrent() {
    if (!currentId) return;
    const p = getParty(currentId);
    if (!p) return;

    p.type = (typeEl.value || "").trim();
    p.date = dateEl.value || "";
    p.time = timeEl.value || "";
    p.location = (locationEl.value || "").trim();
    p.notes = (notesEl.value || "").trim();
    p.updatedAt = new Date().toISOString();

    saveParties();
    renderPartyList();
    toast("Saved");
  }

  function deleteCurrent() {
    if (!currentId) return;
    const p = getParty(currentId);
    if (!p) return;

    if (!confirm(`Delete "${p.name}"?`)) return;

    parties = parties.filter(x => x.id !== currentId);
    saveParties();
    renderPartyList();
    toast("Deleted");
    showHome();
  }

  function shareUrlFor(id) {
    const url = new URL(window.location.href);
    url.pathname = url.pathname.replace(/\/[^\/]*$/, "/partyplus.html");
    url.searchParams.set("party", id);
    return url.toString();
  }

  async function copyText(text) {
    try {
      await navigator.clipboard.writeText(text);
      toast("Link copied");
      return true;
    } catch {
      // fallback
      const ta = document.createElement("textarea");
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      try {
        document.execCommand("copy");
        toast("Link copied");
        return true;
      } catch {
        toast("Copy failed");
        return false;
      } finally {
        ta.remove();
      }
    }
  }

  async function shareCurrent() {
    if (!currentId) return;
    const p = getParty(currentId);
    if (!p) return;

    const url = shareUrlFor(currentId);
    const title = `PartyPlus: ${p.name || "Party"}`;
    const text = `Join my party: ${p.name || "Party"}`;

    if (navigator.share) {
      try {
        await navigator.share({ title, text, url });
        toast("Shared");
        return;
      } catch {
        // if user cancels, just ignore
      }
    }
    await copyText(url);
  }

  function resetAll() {
    if (!confirm("Reset ALL parties? This cannot be undone.")) return;
    parties = [];
    saveParties();
    renderPartyList();
    toast("Reset complete");
    showHome();
  }

  // ====== Events ======
  createBtn.addEventListener("click", createParty);
  resetAllBtn.addEventListener("click", resetAll);
  homeBtn.addEventListener("click", showHome);

  searchEl.addEventListener("input", renderPartyList);
  sortEl.addEventListener("change", renderPartyList);

  saveBtn.addEventListener("click", saveCurrent);
  deleteBtn.addEventListener("click", deleteCurrent);
  shareBtn.addEventListener("click", shareCurrent);
  copyLinkBtn.addEventListener("click", async () => {
    if (!currentId) return;
    await copyText(shareUrlFor(currentId));
  });

  // ====== Auto-open shared party (ONLY ONE block) ======
  function autoOpenSharedParty() {
    try {
      const params = new URLSearchParams(window.location.search);
      const sharedId = params.get("party");
      if (sharedId) {
        // Wait for list + handlers to be ready
        setTimeout(() => openParty(sharedId), 0);
      }
    } catch {}
  }

  // ====== PWA install prompt ======
  const installBtn = $("installBtn");
  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    installPromptEvent = e;
    installBtn.style.display = "inline-block";
  });
  installBtn.addEventListener("click", async () => {
    if (!installPromptEvent) return;
    installPromptEvent.prompt();
    try { await installPromptEvent.userChoice; } catch {}
    installPromptEvent = null;
    installBtn.style.display = "none";
  });

  // ====== Service worker ======
  if ("serviceWorker" in navigator) {
    window.addEventListener("load", () => {
      navigator.serviceWorker.register("./sw.js").catch(() => {});
    });
  }

  // ====== Boot ======
  loadParties();
  renderPartyList();
  showHome();
  autoOpenSharedParty();

})();
</script>
</body>
</html>